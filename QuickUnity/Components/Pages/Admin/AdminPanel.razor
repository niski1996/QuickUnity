@attribute [Route($"/{AppRoutes.Admin}")]
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using QuickUnity.Common
@using QuickUnity.Data
@using QuickUnity.Services
@inject ApplicationDbContext Context;
@inject IServiceScopeFactory ScopeFactory;
@inject MediaStorageService MediaService

<RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Advanced" AllowSorting="true" PageSize="20" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                Data="@users" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or" SelectionMode="DataGridSelectionMode.Single" >
    <Columns>
        <RadzenDataGridColumn Property="@nameof(UserDto.Id)" Filterable="false" Title="ID" Frozen="true" Width="80px" TextAlign="TextAlign.Center" />
        <RadzenDataGridColumn Title="Photo" Frozen="true" Sortable="false" Filterable="false" Width="80px" TextAlign="TextAlign.Center" >
            <Template Context="data">
                @if (File.Exists(MediaService.GetAvatarPatch(data.Username)))
                {
                <RadzenImage Style="width: 32px; height: 32px; border-radius: 50%;" Path="@MediaService.GetAvatarRelativePatch(data.Username)"></RadzenImage>
                }
                else
                {
                <RadzenGravatar Email=@(data.Username)/>
                }
                <RadzenImage Path="@data.photoPath" class="rz-gravatar" AlternateText="@(data.Name + " " + data.LastName)"/>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(UserDto.Name)" Title="First Name" Frozen="true" Width="160px" />
        <RadzenDataGridColumn Property="@nameof(UserDto.LastName)" Title="Last Name" Width="160px"/>
        <RadzenDataGridColumn Property="@nameof(UserDto.Username)" Title="Username" Width="200px" />
        <RadzenDataGridColumn Property="@nameof(UserDto.EmailConfirmed)" Title="Email confirmed" Width="100px" />
        <RadzenDataGridColumn Property="@nameof(UserDto.JoinDate)" Title="User since" Width="100px" />
        <RadzenDataGridColumn Title="Role" Width="100px" Sortable="true" Filterable="false">
            <Template Context="data">
                <RadzenSplitButton Click="@(args => AssignRole(data.Id, args.Value))" Text="@data.Role">
                    <ChildContent>
                        <RadzenSplitButtonItem Text="User" Value="@predefinedRoles.User.ToString()" />
                        <RadzenSplitButtonItem Text="Trainer" Value="@predefinedRoles.Trainer.ToString()" />
                        <RadzenSplitButtonItem Text="Admin" Value="@predefinedRoles.Admin.ToString()" />
                    </ChildContent>
                </RadzenSplitButton>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="Actions" Width="100px" Sortable="false" Filterable="false">
            <Template Context="data">
                <RadzenButton Text="Delete user" Click="@(() => DeleteUser(data.Id))" ButtonStyle="ButtonStyle.Danger"/>
            </Template>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

@code {
    private List<UserDto> users = new();

    protected override Task OnInitializedAsync()
    {
        FetchData();
        return base.OnInitializedAsync();
    }

    private void FetchData()
    {
        
            var identityUsers = Context.Set<ApplicationUser>().Include(x=>x.Profile).ToList();
            var roles = Context.Set<IdentityRole>().ToList();
            var userRoles = Context.UserRoles.ToList(); // Assuming you have UserRoles set up

            users = identityUsers.Select(user =>
            {
                var userRole = userRoles.FirstOrDefault(ur => ur.UserId == user.Id);
                var roleName = userRole != null ? roles.FirstOrDefault(r => r.Id == userRole.RoleId)?.Name : "No Role";

                return new UserDto(user, roleName);
            }).ToList();
        
    }
    
    private async Task DeleteUser(string userId)
    {
        var user = await Context.Set<ApplicationUser>().FirstAsync(x => x.Id == userId);
        Context.Set<ApplicationUser>().Remove(user);
        await Context.SaveChangesAsync();
        FetchData();


    }
    
    private async Task AssignRole(string userId, string role)
    {
        await using var scope = ScopeFactory.CreateAsyncScope();
        var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
        
        var user = await userManager.FindByIdAsync(userId); 
        if (user != null)
        {
            foreach (var userRole in await userManager.GetRolesAsync(user))
            {
                if (userRole != role)
                {
                    await userManager.RemoveFromRoleAsync(user, userRole);
                }
            }
            if (!await userManager.IsInRoleAsync(user, role))
            {
                await userManager.AddToRoleAsync(user, role);
            }
            FetchData();
        }
    }
    private class UserDto
    {
        public UserDto(ApplicationUser user, string role)
        {
            Id = user.Id;
            Email = user.Email ?? "";
            Username = user.UserName ?? "";
            Role = role;
            Name = user.Profile?.Name??"";
            LastName = user.Profile?.LastName??"";
            JoinDate = user.Profile?.JoinDate??new DateOnly();
            EmailConfirmed = user.EmailConfirmed;
        }

        public string Id { get; set; }
        public string Name { get; set; }
        public string photoPath { get; set; }
        public string LastName { get; set; }
        public string Username { get; set; }
        public DateOnly JoinDate { get; set; }
        public string Email { get; set; }
        public bool EmailConfirmed { get; set; }
        public string Role { get; set; }
    }

    private enum predefinedRoles
    {
        User,
        Trainer,
        Admin,
    }

}